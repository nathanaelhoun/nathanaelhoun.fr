var isOnFocus=!0,isOnPause=!1,gravityRecheck=!1,isMedicineFalling=!1,numLevel=1,victory=!1,defeat=!1,topScore=1e4,playerScore=0,levelNumberOfVirus=1,showStartTimer=0,showStartText=!1,bottle=[];const EMPTY_BOX={type:0,color:0,attached:0},COLORS=["blue","red","yellow"],BACKGROUND_COLOR="grey",BORDERS_COLOR="darkblue",BOX_WIDTH=25,BOX_HEIGHT=BOX_WIDTH,BOTTLE_HEIGHT=16,BOTTLE_WIDTH=8,VIRUS=1,CAPSULE=2,FALLING_CAPSULE=3,REFRESH_SPEED=1e3,GRAVITY_SPEED=300,TOP=0,RIGHT=1,BOTTOM=2,LEFT=3;var medicine={x:-1,y:-1,direction:RIGHT,color1:"green",color2:"green"},nextMedicine={x:-1,y:-1,direction:RIGHT,color1:"green",color2:"green"};function isVictory(){return 0==countRemainingVirusNumber(bottle)}function isDefeat(){return 0!=bottle[0][3].type||0!=bottle[0][4].type}function replayTheGame(){victory?(numLevel++,victory=!1,isMedicineFalling=!0,bottle=randomVirus(bottle=bottleInitialization(bottle),4*numLevel),medicine=createMedicine(medicine)):defeat&&(defeat=!1,playerScore=0,bottle=randomVirus(bottle=bottleInitialization(bottle),4*numLevel),medicine=createMedicine(medicine))}function randomColor(){return COLORS[Math.floor(Math.random()*COLORS.length)]}function bottleInitialization(e){for(var t=0;t<BOTTLE_HEIGHT;t++){for(var i=[],n=0;n<BOTTLE_WIDTH;n++)i[n]=JSON.parse(JSON.stringify(EMPTY_BOX));e[t]=i}return e}function randomVirus(e,t){for(var i=0;i<t&&!isBottleFilled(e);){var n=-1,c=-1;do{n=Math.floor(Math.random()*(BOTTLE_HEIGHT-4)+4),c=Math.floor(Math.random()*BOTTLE_WIDTH)}while(0!==e[n][c].type&&!isBottleFilled(e));n>=0&&c>=0&&(e[n][c].color=randomColor(),e[n][c].type=VIRUS,e[n][c].attached=-1,i++)}return levelNumberOfVirus=t,e}function isBottleFilled(e){for(var t=!1,i=4,n=0;i<BOTTLE_HEIGHT&&!t;){for(n=0;n<BOTTLE_WIDTH&&!t;)0===e[i][n].type&&(t=!0),n++;i++}return!t}function countRemainingVirusNumber(e){for(var t=0,i=0;i<BOTTLE_HEIGHT;i++)for(var n=0;n<BOTTLE_WIDTH;n++)e[i][n].type==VIRUS&&t++;return t}function detectColorMatching(e){var t,i;do{t=!1;for(var n=15;n>=3&&!t;){for(var c=0;c<8&&!t;){if(0!=bottle[n][c].type&&e[n][c].color==e[n-1][c].color&&e[n][c].color==e[n-2][c].color&&e[n][c].color==e[n-3][c].color){t=!0;var o=n;do{switch(e[o][c].attached){case RIGHT:e[o][c+1].attached=-1;break;case TOP:e[o-1][c].attached=-1;break;case LEFT:e[o][c-1].attached=-1;break;case BOTTOM:e[o+1][c].attached=-1}e[o][c]=JSON.parse(JSON.stringify(EMPTY_BOX)),o--}while(e[o][c].color==e[o-1][c].color);switch(e[o][c].attached){case RIGHT:e[o][c+1].attached=-1;break;case TOP:e[o-1][c].attached=-1;break;case LEFT:e[o][c-1].attached=-1;break;case BOTTOM:e[o+1][c].attached=-1}e[o][c]=JSON.parse(JSON.stringify(EMPTY_BOX)),gravityRecheck=!0}c++}n--}}while(t);do{i=!1;for(n=15;n>=0&&!i;){for(c=0;c<5&&!i;){if(0!=bottle[n][c].type&&e[n][c].color==e[n][c+1].color&&e[n][c].color==e[n][c+2].color&&e[n][c].color==e[n][c+3].color){i=!0;for(var r=c;e[n][r].color==e[n][r+1].color;){switch(e[n][r].attached){case RIGHT:e[n][r+1].attached=-1;break;case TOP:e[n-1][r].attached=-1;break;case LEFT:e[n][r-1].attached=-1;break;case BOTTOM:e[n+1][r].attached=-1}e[n][r]=JSON.parse(JSON.stringify(EMPTY_BOX)),r++}switch(e[n][r].attached){case RIGHT:e[n][r+1].attached=-1;break;case TOP:e[n-1][r].attached=-1;break;case LEFT:e[n][r-1].attached=-1;break;case BOTTOM:e[n+1][r].attached=-1}e[n][r]=JSON.parse(JSON.stringify(EMPTY_BOX)),gravityRecheck=!0}c++}n--}}while(i);return e}function capsuleGravity(e){gravityRecheck=!1;for(var t=14;t>=0;t--)for(var i=0;i<8;i++)if(e[t][i].type===CAPSULE&&t+1<16&&(0==e[t+1][i].type||e[t+1][i].type==FALLING_CAPSULE)){var n=!0;switch(e[t][i].attached){case RIGHT:0!=e[t+1][i+1].type&&e[t+1][i+1].type!=FALLING_CAPSULE&&(n=!1);break;case LEFT:0!=e[t+1][i-1].type&&e[t+1][i-1].type!=FALLING_CAPSULE&&(n=!1)}n&&(gravityRecheck=!0,e[t][i].type=FALLING_CAPSULE)}for(t=14;t>=0;t--)for(i=0;i<8;i++)e[t][i].type===FALLING_CAPSULE&&(e[t+1][i].color=e[t][i].color,e[t+1][i].type=CAPSULE,e[t+1][i].attached=e[t][i].attached,e[t][i]=JSON.parse(JSON.stringify(EMPTY_BOX)));return e}function createMedicine(e){return{x:3,y:0,direction:RIGHT,color1:randomColor(),color2:randomColor()}}function copyMedicine(e,t){return t={x:e.x,y:e.y,direction:e.direction,color1:e.color1,color2:e.color2},isMedicineFalling=!0,gravityRecheck=!1,t}function medicineFalling(e){if(e.y>=15)isMedicineFalling=!1;else if(0!=bottle[e.y+1][e.x].type)isMedicineFalling=!1;else switch(e.direction){case RIGHT:0!=bottle[e.y+1][e.x+1].type&&(isMedicineFalling=!1);break;case LEFT:0!=bottle[e.y+1][e.x-1].type&&(isMedicineFalling=!1);break;case BOTTOM:e.y>=14?isMedicineFalling=!1:0!=bottle[e.y+2][e.x].type&&(isMedicineFalling=!1)}return isMedicineFalling&&e.y++,e}function transferMedicineToBottle(e,t){if(-1!=t.x){var i,n,c;switch(e[t.y][t.x].type=CAPSULE,e[t.y][t.x].color=t.color1,e[t.y][t.x].attached=t.direction,t.direction){case RIGHT:i=t.x+1,n=t.y,c=LEFT;break;case BOTTOM:i=t.x,n=t.y+1,c=TOP;break;case LEFT:i=t.x-1,n=t.y,c=RIGHT;break;case TOP:i=t.x,n=t.y-1,c=BOTTOM}e[n][i].type=CAPSULE,e[n][i].color=t.color2,e[n][i].attached=c,medicine={x:-1,y:-1,direction:RIGHT,color1:"green",color2:"green"},gravityRecheck=!0}return e}function moveMedicineDown(){var e=!0;if(medicine.y>=15||-1==medicine.x)e=!1;else if(0!=bottle[medicine.y+1][medicine.x].type)e=!1;else switch(medicine.direction){case RIGHT:0!=bottle[medicine.y+1][medicine.x+1].type&&(e=!1);break;case LEFT:0!=bottle[medicine.y+1][medicine.x-1].type&&(e=!1);break;case BOTTOM:medicine.y>=14?e=!1:0!=bottle[medicine.y+2][medicine.x].type&&(e=!1)}e?medicine.y++:isMedicineFalling=!1}function moveMedicineLeft(){var e=!0;if(medicine.x<=0)e=!1;else if(0!=bottle[medicine.y][medicine.x-1].type)e=!1;else switch(medicine.direction){case LEFT:medicine.x<=1?e=!1:0!=bottle[medicine.y][medicine.x-2].type&&(e=!1);break;case BOTTOM:0!=bottle[medicine.y+1][medicine.x-1].type&&(e=!1);break;case TOP:0!=bottle[medicine.y-1][medicine.x-1].type&&(e=!1)}e&&medicine.x--}function moveMedicineRight(){var e=!0;if(medicine.x>=7||-1==medicine.x)e=!1;else if(0!=bottle[medicine.y][medicine.x+1].type)e=!1;else switch(medicine.direction){case RIGHT:medicine.x>=6?e=!1:0!=bottle[medicine.y][medicine.x+2].type&&(e=!1);break;case BOTTOM:0!=bottle[medicine.y+1][medicine.x+1].type&&(e=!1);break;case TOP:0!=bottle[medicine.y-1][medicine.x+1].type&&(e=!1)}e&&medicine.x++}function rotateMedicine(){if(-1!=medicine.x){var e=!0,t=medicine.direction-1;t<0&&(t=3);var i=medicine.x,n=medicine.y;switch(t){case RIGHT:n+=1,medicine.x>=7?i-=1:0!=bottle[medicine.y+1][medicine.x+1].type&&(0==bottle[medicine.y][medicine.x-1].type?i-=1:e=!1);break;case BOTTOM:i-=1,n-=1,0!=bottle[medicine.y-1][medicine.x-1].type&&(0==bottle[medicine.y+1][medicine.x].type?n+=1:e=!1);break;case LEFT:i+=1,medicine.x>=7?(i-=1,0!=bottle[medicine.y][medicine.x-1].type&&(e=!1)):0!=bottle[medicine.y][medicine.x+1].type&&(0==bottle[medicine.y][medicine.x-1].type?i-=1:e=!1);break;case TOP:0!=bottle[medicine.y-1][medicine.x].type&&(0==bottle[medicine.y+1][medicine.x].type?n+=1:e=!1)}e&&(medicine.direction=t,medicine.x=i,medicine.y=n)}}function renderTopLeftCorner(e,t,i){context.fillStyle=i,context.fillRect(e,t,1,4),context.fillRect(e+1,t,3,1),context.fillRect(e+1,t+1,1,1)}function renderTopRightCorner(e,t,i){context.fillStyle=i,context.fillRect(e+20,t,1,4),context.fillRect(e+17,t,3,1),context.fillRect(e+19,t+1,1,1)}function renderBottomLeftCorner(e,t,i){context.fillStyle=i,context.fillRect(e,t+17,1,4),context.fillRect(e+1,t+20,3,1),context.fillRect(e+1,t+19,1,1)}function renderBottomRightCorner(e,t,i){context.fillStyle=i,context.fillRect(e+20,t+17,1,4),context.fillRect(e+17,t+20,3,1),context.fillRect(e+19,t+19,1,1)}function renderVirus(e,t,i){context.fillStyle=i,context.fillRect(e,t,BOX_HEIGHT-4,BOX_WIDTH-4),context.fillStyle="black",context.fillRect(e+4,t+4,3,5),context.fillRect(e+14,t+4,3,5),context.fillRect(e+4,t+13,12,3),context.fillRect(e+3,t+15,3,3),context.fillRect(e+15,t+15,3,3),renderTopLeftCorner(e,t,BACKGROUND_COLOR),renderTopRightCorner(e,t,BACKGROUND_COLOR),renderBottomLeftCorner(e,t,BACKGROUND_COLOR),renderBottomRightCorner(e,t,BACKGROUND_COLOR)}function renderVictoryScreen(){context.fillStyle="black",context.fillRect(210,200,180,200),context.fillStyle=BACKGROUND_COLOR,context.fillRect(215,205,170,190),context.font="40px Verdana",context.fillStyle="black",context.fillText("STAGE",220,250,160),context.fillText("CLEAR",250,285,130),context.fillText("TRY",230,350,150),context.fillText("NEXT",270,385,110)}function renderDefeatScreen(){context.fillStyle="black",context.fillRect(210,200,180,200),context.fillStyle="darkgrey",context.fillRect(215,205,170,190),context.font="40px Verdana",context.fillStyle="black",context.fillText("DEFEAT",220,250,160),context.fillText("TRY",220,350,160),context.fillText("AGAIN",250,385,130)}function renderEmptyPanel(e,t,i,n){context.fillStyle=BORDERS_COLOR,context.fillRect(e,t,i+4,n+4),context.fillStyle=BACKGROUND_COLOR,context.fillRect(e+2,t+2,i,n)}function renderScorePanel(){renderEmptyPanel(70,140,100,100),context.fillStyle="black",context.font="bold 25px Arial",context.fillText("TOP : ",77,167,90),context.fillText(topScore,77,189,90),context.fillText("SCORE : ",77,217,90),context.fillText(playerScore,77,237,90)}function renderInformationPanel(){renderEmptyPanel(425,300,100,200),context.fillStyle="black",context.font="bold 25px Arial",context.fillText("LEVEL ",432,332,90),context.fillText(numLevel,472,357,50),context.fillText("SPEED ",432,397,90),context.fillText("So low",432,422,90),context.fillText("VIRUS ",432,462,90),context.fillText(levelNumberOfVirus,472,487,50)}function renderStartText(){Date.now()-showStartTimer>500&&(showStartText=!showStartText,showStartTimer=Date.now()),showStartText&&(context.font="40px Verdana",context.fillStyle="white",context.fillText("START",240,500,120))}function renderMedicine(e,t,i,n,c){switch(context.fillStyle=i,context.fillRect(e,t,BOX_HEIGHT-4,BOX_WIDTH-4),c){case RIGHT:renderTopLeftCorner(e,t,BACKGROUND_COLOR),renderBottomLeftCorner(e,t,BACKGROUND_COLOR);break;case LEFT:renderBottomRightCorner(e,t,BACKGROUND_COLOR),renderTopRightCorner(e,t,BACKGROUND_COLOR);break;case BOTTOM:renderTopLeftCorner(e,t,BACKGROUND_COLOR),renderTopRightCorner(e,t,BACKGROUND_COLOR);break;case TOP:renderBottomLeftCorner(e,t,BACKGROUND_COLOR),renderBottomRightCorner(e,t,BACKGROUND_COLOR)}switch(context.fillStyle=n,c){case LEFT:e-=BOX_WIDTH,context.fillRect(e,t,BOX_HEIGHT-4,BOX_WIDTH-4),renderTopLeftCorner(e,t,BACKGROUND_COLOR),renderBottomLeftCorner(e,t,BACKGROUND_COLOR);break;case RIGHT:e+=BOX_WIDTH,context.fillRect(e,t,BOX_HEIGHT-4,BOX_WIDTH-4),renderBottomRightCorner(e,t,BACKGROUND_COLOR),renderTopRightCorner(e,t,BACKGROUND_COLOR);break;case BOTTOM:t+=BOX_HEIGHT,context.fillRect(e,t,BOX_HEIGHT-4,BOX_WIDTH-4),renderBottomLeftCorner(e,t,BACKGROUND_COLOR),renderBottomRightCorner(e,t,BACKGROUND_COLOR);break;case TOP:t-=BOX_HEIGHT,context.fillRect(e,t,BOX_HEIGHT-4,BOX_WIDTH-4),renderTopLeftCorner(e,t,BACKGROUND_COLOR),renderTopRightCorner(e,t,BACKGROUND_COLOR)}}function init(){context=document.getElementById("cvs").getContext("2d"),context.width=document.getElementById("cvs").width,context.height=document.getElementById("cvs").height,document.body.onblur=function(){isOnFocus=!1},document.body.onfocus=function(){isOnFocus=!0},bottle=randomVirus(bottle=bottleInitialization(bottle),4*numLevel),nextMedicine=createMedicine(medicine),medicine=createMedicine(medicine),isMedicineFalling=!0,document.addEventListener("keydown",captureKeyboardPress),document.addEventListener("keyup",captureKeyboardReleased),lastUpdate=Date.now(),lastRefresh=Date.now(),gameLoop()}function gameLoop(){!isOnFocus||isOnPause?(document.title="DrMario - en pause",render()):(document.title="DrMario",defeat||victory||update(),render()),requestAnimationFrame(gameLoop)}function update(){let e=levelNumberOfVirus;isMedicineFalling?Date.now()-lastRefresh>REFRESH_SPEED&&(medicine=medicineFalling(medicine),lastRefresh=Date.now()):(bottle=transferMedicineToBottle(bottle,medicine),gravityRecheck?Date.now()-lastRefresh>GRAVITY_SPEED&&(bottle=capsuleGravity(bottle),lastRefresh=Date.now()):(bottle=detectColorMatching(bottle),isDefeat()?defeat=!0:gravityRecheck||(medicine=copyMedicine(nextMedicine,medicine),nextMedicine=createMedicine(nextMedicine)))),levelNumberOfVirus=countRemainingVirusNumber(bottle),topScore<(playerScore+=200*(e-levelNumberOfVirus))&&(topScore=playerScore),isVictory()&&(victory=!0)}function render(){context.fillStyle="black",context.fillRect(0,0,context.width,context.height),renderScorePanel(),renderInformationPanel(),renderEmptyPanel(425,170,100,100),context.fillStyle="black",context.fillRect(473,212,4,21),renderMedicine(452,212,nextMedicine.color1,nextMedicine.color2,nextMedicine.direction),context.fillStyle=BORDERS_COLOR,context.fillRect(190,130,220,420),context.fillStyle=BACKGROUND_COLOR,context.fillRect(193,133,214,414),context.fillStyle=BORDERS_COLOR,context.fillRect(197,137,206,406);for(var e=0;e<BOTTLE_HEIGHT;e++)for(var t=0;t<BOTTLE_WIDTH;t++){context.fillStyle=BORDERS_COLOR,context.fillRect(200+25*t,140+25*e,BOX_HEIGHT,BOX_WIDTH);var i=202+BOX_WIDTH*t,n=142+BOX_HEIGHT*e;switch(bottle[e][t].type){case 0:context.fillStyle=BACKGROUND_COLOR,context.fillRect(i,n,BOX_HEIGHT-4,BOX_WIDTH-4);break;case VIRUS:renderVirus(i,n,bottle[e][t].color);break;case CAPSULE:case FALLING_CAPSULE:switch(context.fillStyle=bottle[e][t].color,context.fillRect(i,n,BOX_HEIGHT-4,BOX_WIDTH-4),bottle[e][t].attached){case RIGHT:renderTopLeftCorner(i,n,BACKGROUND_COLOR),renderBottomLeftCorner(i,n,BACKGROUND_COLOR);break;case LEFT:renderTopRightCorner(i,n,BACKGROUND_COLOR),renderBottomRightCorner(i,n,BACKGROUND_COLOR);break;case BOTTOM:renderTopLeftCorner(i,n,BACKGROUND_COLOR),renderTopRightCorner(i,n,BACKGROUND_COLOR);break;case TOP:renderBottomLeftCorner(i,n,BACKGROUND_COLOR),renderBottomRightCorner(i,n,BACKGROUND_COLOR);break;default:renderTopLeftCorner(i,n,BACKGROUND_COLOR),renderTopRightCorner(i,n,BACKGROUND_COLOR),renderBottomLeftCorner(i,n,BACKGROUND_COLOR),renderBottomRightCorner(i,n,BACKGROUND_COLOR)}}}medicine.x>=0&&renderMedicine(202+BOX_WIDTH*medicine.x,142+BOX_HEIGHT*medicine.y,medicine.color1,medicine.color2,medicine.direction),victory?(renderVictoryScreen(),renderStartText()):defeat&&(renderDefeatScreen(),renderStartText())}captureKeyboardPress=function(e){switch(e.keyCode){case 80:isOnPause=!isOnPause;break;case 37:moveMedicineLeft();break;case 39:moveMedicineRight();break;case 40:moveMedicineDown();break;case 32:rotateMedicine();break;case 13:replayTheGame()}},captureKeyboardReleased=function(e){e.keyCode};